#!/bin/bash
# Author: Kent Chadwick
# Description: Adds new business records to the "BusinessDetails" file
#
newBiz="$1	$2	$3	$4	$5"

# Count the number of records that match the user's search input, and store the value in $inputCount
inputCount=$(grep -ci "$newBiz" BusinessDetails)

if [ $inputCount -gt 0 ]; then
	echo
	echo "An identical record already exists!"
	read -p "Would you like to attempt adding a new business again? (y/n): " ans
        if [[ $ans == y* || $ans == Y* ]]; then
		 # Read in uper input for Business details and pass the variables to the AddBiz script as arguments
	        echo
	        echo "Please enter the business name: "
	        read bizName
	        nameMenu=true
	        while [ $nameMenu == true ]; do # while loop to control validation of input
	                if [ -z "$bizName" ]; then # checks for empty string
	                        echo
	                        echo "No text entered. Please enter the business name again (0 to return to main menu): "
	                        read bizName
	                        if [ $bizName -eq 0 ] 2> /dev/null # checks for entry of 0
	                        then 
	                                nameMenu=false
	                                ./Menu
	                        fi
	                else
	                        nameMenu=false
	                fi
	        done
	        echo
	        echo "Please enter the contact person's name: "
	        read contactName
	        contactMenu=true
	        while [ $contactMenu == true ]; do # while loop to control validation of input
	                if [ -z "$contactName" ]; then # checks for empty string
	                        echo
	                        echo "No text entered. Please enter the contact's name again (0 to return to main menu): "
	                        read contactName
	                        if [ $contactName -eq 0 ] 2> /dev/null # checks for entry of 0
	                        then 
	                                contactMenu=false
	                                ./Menu
	                        fi
	                else
	                        contactMenu=false
	                fi
	        done
	        echo
	        echo "Please enter the business address: "
	        read bizAddress
	        addressMenu=true
	        while [ $addressMenu == true ]; do # while loop to control validation of input
	                if [ -z "$bizAddress" ]; then # checks for empty string
	                        echo
	                        echo "No text entered. Please enter the address again (0 to return to main menu): "
	                        read bizAddress
	                        if [ $bizAddress -eq 0 ] 2> /dev/null # checks for entry of 0
	                        then
	                                addressMenu=false
	                                ./Menu
	                        fi
	                else
	                        addressMenu=false
	                fi
	        done
	        echo
	        echo "Please enter the contact person's phone number: "
	        read contactNum
	        numMenu=true
	        phoneRegEx="\b[0-9._+-]{3,16}\b" # regex for phone patterns
	        while [ $numMenu == true ]; do # while loop to control validation of input
	                if [ -z "$contactNum" ]; then # checks for empty string
	                        echo
	                        echo "No number entered. Please enter the contact number (0 to return to main menu): "
	                        read contactNum
	                        if [ $contactNum -eq 0 ] 2> /dev/null # checks for entry of 0
	                        then
	                                numMenu=false
	                                ./Menu
	                        fi
	                elif [[ $contactNum =~ $phoneRegEx ]]; then # check for phone number format
	                        numMenu=false
	                else
	                        echo
	                        echo "Invalid entry. Phone number must be between 3 and 15 characters,"
	                        echo "and contain only numbers or the following symbols: . _ - +"
	                        echo
	                        echo "Please enter the contact person's phone number: "
	                        read contactNum
	                fi
	        done
	        echo
	        echo "Please enter contact person's email address: "
	        read contactEmail
	        emailRegEx="\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b"
	        emailMenu=true
	        while [ $emailMenu == true ]; do
	                if [[ $contactEmail =~ $emailRegEx ]]; then
	                        emailMenu=false
	                else
	                        echo
	                        echo "Invalid email address entered. Please enter the email address again (0 to return to main menu): "
	                        read contactEmail
	                        if [ $contactEmail -eq 0 ] 2> /dev/null # checks for entry of 0
	                        then
	                                numMenu=false
	                                ./Menu
	                        fi
	                fi
	        done
	        echo
	        ./AddBiz "$bizName" "$contactName" "$bizAddress" "$contactNum" "$contactEmail"
	        echo
	        echo "New business - \"$bizName\" - added."
	        echo

	else
		./Menu
	fi
else
	echo "$newBiz" >> BusinessDetails
fi
